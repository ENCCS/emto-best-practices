# EMTO leture

## The EMTO Method Fundamentals, Implementation and Demonstration

{download}`by Prof. Levente Vitos<ENCCS2024.04.16.pdf>`

## Basic About How to Run EMTO Code

|exe     |function|
|--------|---|
|bmdl    |Calculates the Madelung potentials|
|kstr    |Computes the energy dependent slope matrix in real space.|
|shape   |Computes the so called shape function, which transforms any integral over the unit cell into an integral over a sphere surrounding the unit cell.|
|kgrn_cpa|Solves the actual self-consistent Kohn-Sham equations And calculate the Full charge density|
|kfcd_cpa|Evaluate the total energy functional from the full charge density generated by kgrn|

### Running dependence of EMTO subprograms

```{image} img/001.svg
:width: 400px
:align: center
```

Commands to run the code looks like:
```
exe < input
```

#### exercise/00

```bash
tree 00
00
├── bmdl
│   └── fcc.dat
├── kfcd
│   └── cu.dat
├── kgrn
│   └── cu.dat
├── kstr
│   └── fcc.dat
└── shape
    └── fcc.dat

6 directories, 5 files
```

- please try to run these "dat" file as input for each "exe" inside its folder.
  for example:
  ```bash
  cd 00/bmdl
  bmdl < fcc.dat
  ```
  there will be errors, so what should we do ?
  ````{hint}
  :class: dropdown
  ```bash
  mkdir mdl
  bmdl < fcc.dat
  ```
  ````


```{caution}
EMTO input files have very strict format, an extra space may cause some problems.
```
#### KSTR

```{literalinclude} exercise/solutions/00/kstr/fcc.dat
:caption: The input file (kstr/fcc.dat)
:emphasize-lines: 2,3,4,8,9,13
:linenos:
```

A part of the input file of `kstr` describes the lattice informations:
- Total number of sites is set by NQ3.
- The symmetry is set by `LAT`, more in the [online manual](https://emto.gitlab.io/manual/manual.html#kstr).
- The lattice parameters are renormalized to the length of first lattice vector A (`A=1`).
- **Cartesian Coordinates** are used for sites/"atom" with `QX,QY,QZ`.

Commands for run the `kstr`:
```
kstr < fcc.dat
```

Or add `time` in front to have a feeling about the how much time each code consumes:

```bash
time kstr < fcc.dat
```

- `DIR006=./` and `JOBNAM...=fcc`: a file `fcc.prn` will be generated in the current directory.
- `DIR001=smx`: "slop matrix" will save to `smx/fcc.tfh`.
- `MSGL.=  0` could silence the screen printing.

#### BMDL

```{literalinclude} exercise/solutions/00/bmdl/fcc.dat
:caption: The input file (bmdl/fcc.dat)
:emphasize-lines: 2,3,8,9,10,11,12,13
:linenos:
```

The Lattice information must be consistent with `kstr`, and the output files will be `./fcc.prn` and `mdl/fcc.mdl`

#### SHAPE

The input file (shape/fcc.dat) for `bmdl` contains similar lattice information as `kstr`:

```{literalinclude} exercise/solutions/00/shape/fcc.dat
:caption: The input file (shape/fcc.dat)
:linenos:
:emphasize-lines: 2,3,4
```

`FOR001=../kstr/smx/fcc.tfh` shows `shape` will need the "slop matrix" from the result of `kstr`. 
The output will be `shp/fcc.shp`.

```{hint}
`kstr,bmdl` and `shape` only contains lattice information with a reduced unit, 
They could be reused for any system which present with same lattice setup.
```

#### KGRN


```{literalinclude} exercise/solutions/00/kgrn/cu.dat
:emphasize-lines: 2,4,8,10,24,26
:linenos:
```
- need `chd\` and `pot\` to be exist.
- `JOBNAM=cu` will decide the output files start with `cu`: cu.prn, chd/cu.chd, pot/cu.pot …
- `FOR001=../kstr/smx/fcc.tfh` and `FOR004=../bmdl/mdl/fcc.mdl`.
- `IBZ..=  2` should consistent with `LAT=2` in `kstr` and `bmdl` for `fcc`.
- `NITER.= 50`, `TOLE...= 1.d-07 TOLEF.= 1.d-07`, \
check with `egrep "erre|Converged|NOS|finished" cu.prn`.
- `AMIX...=  0.100` mixing factor for new charge.
- `SWS......=2.686842`: The average Wigner-Seitz radius (bohr) to scale the lattice.
   ````{note}
   e.g bcc lattice parameters (a) to SWS ({math}`\omega`):
   ```{math}
   2\times \frac{4\pi}{3} \omega^3 = a^3
   ```
   units:
     * length: [Bohr](https://en.wikipedia.org/wiki/Bohr_radius), 1 Bhor = 0.529177249 Angstrom
     * energy: [Rydberg](https://en.wikipedia.org/wiki/Rydberg_constant#Rydberg_unit_of_energy), 1 Ry = 13.605703976 eV
   ````

```{math}
N(\epsilon_F)=\frac{1}{2\pi i}\oint_{\epsilon_F} G(z)~dz
```
```{image} img/contour_dos.svg
:width: 800px
:align: center
```
